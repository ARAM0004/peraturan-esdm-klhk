<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Peraturan ESDM, KLHK & Perda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #ca8a04;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 min-h-screen">
    <div id="app"></div>

    <script>
        // GITHUB CONFIG - PASTIKAN INI BENAR!
        const GITHUB_REPO = "ARAM0004/peraturan-esdm-klhk";
        const GITHUB_API = `https://api.github.com/repos/${GITHUB_REPO}`;
        const RAW_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main`;

        // Debug mode
        const DEBUG = true;
        function log(msg, data = null) {
            if (DEBUG) {
                console.log(`[DEBUG] ${msg}`, data || '');
            }
        }

        const DEFAULT_CONFIG = {
            scraper: {
                esdm_klhk: {
                    enabled: true,
                    schedule: '0 1 * * *',
                    limit: 10,
                    auto_publish_days: 7,
                    esdm: {
                        keywords: ['pertambangan', 'mineral', 'batubara', 'tambang'],
                        types: ['Peraturan Menteri', 'Keputusan Menteri']
                    },
                    klhk: {
                        keywords: ['pertambangan', 'lingkungan', 'kehutanan', 'reklamasi', 'amdal'],
                        types: ['Peraturan Menteri', 'Keputusan Menteri']
                    }
                },
                perda: {
                    enabled: true,
                    schedule: '0 2 * * 0',
                    limit: 20,
                    provinces: [
                        { url: 'https://jdih.sulutprov.go.id/', name: 'Sulawesi Utara', code: 'SULUT', enabled: true },
                        { url: 'https://jdih.kaltaraprov.go.id/', name: 'Kalimantan Utara', code: 'KALTARA', enabled: true }
                    ],
                    keywords: ['pertambangan', 'tambang', 'mineral', 'galian']
                }
            },
            display: {
                theme: 'yellow',
                itemsPerPage: 20,
                showStats: true,
                showLastUpdate: true
            },
            categories: {
                enabled: ['Perizinan', 'Lingkungan', 'Keselamatan Kerja', 'Teknis Pertambangan', 'Reklamasi', 'Pajak & Royalti', 'Perda', 'Lainnya']
            },
            ministries: {
                enabled: ['ESDM', 'KLHK', 'Perda', 'Gabungan']
            }
        };

        let state = {
            regulations: [],
            pendingRegs: [],
            filteredRegs: [],
            searchTerm: '',
            selectedCategory: 'Semua',
            selectedMinistry: 'Semua',
            isAdmin: false,
            activeTab: 'published',
            loading: true,
            loadingError: null,
            lastScrapedDate: null,
            showConfigPanel: false,
            processingAction: false,
            notification: null,
            config: { ...DEFAULT_CONFIG },
            currentPage: 1
        };

        const categories = ['Semua', ...DEFAULT_CONFIG.categories.enabled];
        const ministries = ['Semua', ...DEFAULT_CONFIG.ministries.enabled];

        // Notification System
        function showNotification(message, type = 'info') {
            log('Notification:', { message, type });
            state.notification = { message, type };
            render();
            setTimeout(() => {
                state.notification = null;
                render();
            }, 5000);
        }

        // Load data from GitHub
        async function loadData() {
            log('Starting loadData...');
            try {
                const url = `${RAW_URL}/regulations.json?t=${Date.now()}`;
                log('Fetching from:', url);
                
                const response = await fetch(url);
                log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                log('Response length:', text.length);
                
                const data = JSON.parse(text);
                log('Parsed data:', {
                    published: data.published?.length || 0,
                    pending: data.pending?.length || 0
                });
                
                state.regulations = data.published || [];
                state.pendingRegs = data.pending || [];
                state.lastScrapedDate = data.lastUpdated;
                
                showNotification('‚úÖ Data berhasil dimuat', 'success');
                log('Data loaded successfully');
                
            } catch (error) {
                log('Error loading data:', error);
                console.error('Error loading data:', error);
                state.loadingError = error.message;
                showNotification('‚ö†Ô∏è Gagal memuat data: ' + error.message, 'error');
            } finally {
                state.loading = false;
                log('Loading complete, filtering...');
                filterRegulations();
                render();
            }
        }

        // Load config from GitHub
        async function loadConfig() {
            log('Starting loadConfig...');
            try {
                const url = `${RAW_URL}/config.json?t=${Date.now()}`;
                log('Fetching config from:', url);
                
                const response = await fetch(url);
                log('Config response status:', response.status);
                
                if (response.ok) {
                    const text = await response.text();
                    state.config = JSON.parse(text);
                    log('Config loaded:', state.config);
                } else {
                    log('Config not found, using default');
                    state.config = { ...DEFAULT_CONFIG };
                }
            } catch (error) {
                log('Error loading config:', error);
                console.error('Error loading config:', error);
                state.config = { ...DEFAULT_CONFIG };
            }
        }

        async function saveConfig() {
            state.processingAction = true;
            render();

            try {
                const payload = {
                    action: 'update_config',
                    config: state.config,
                    updated_by: 'web_interface',
                    timestamp: new Date().toISOString()
                };

                const getResponse = await fetch(`${GITHUB_API}/contents/trigger/config_update.json`);
                const fileData = await getResponse.json();

                const updateResponse = await fetch(`${GITHUB_API}/contents/trigger/config_update.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Update configuration from web interface',
                        content: btoa(JSON.stringify(payload, null, 2)),
                        sha: fileData.sha
                    })
                });

                if (updateResponse.ok) {
                    showNotification('‚úÖ Konfigurasi disimpan! Refresh dalam 1-2 menit.', 'success');
                    state.showConfigPanel = false;
                } else {
                    throw new Error('GitHub API request failed');
                }
            } catch (error) {
                console.error('Error saving config:', error);
                showNotification('‚ùå Gagal menyimpan konfigurasi', 'error');
            } finally {
                state.processingAction = false;
                render();
            }
        }

        function filterRegulations() {
            log('Filtering regulations...');
            let filtered = state.regulations;

            if (state.selectedMinistry !== 'Semua') {
                filtered = filtered.filter(reg => reg.ministry === state.selectedMinistry);
            }

            if (state.selectedCategory !== 'Semua') {
                filtered = filtered.filter(reg => reg.category === state.selectedCategory);
            }

            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                filtered = filtered.filter(reg =>
                    reg.title.toLowerCase().includes(term) ||
                    reg.number.toLowerCase().includes(term) ||
                    (reg.summary && reg.summary.toLowerCase().includes(term))
                );
            }

            state.filteredRegs = filtered;
            log('Filtered results:', filtered.length);
        }

        // Helper Functions
        function getMinistryColor(ministry) {
            const colors = {
                'ESDM': 'bg-blue-100 text-blue-800 border-blue-300',
                'KLHK': 'bg-green-100 text-green-800 border-green-300',
                'Perda': 'bg-purple-100 text-purple-800 border-purple-300',
                'Gabungan': 'bg-orange-100 text-orange-800 border-orange-300'
            };
            return colors[ministry] || 'bg-gray-100 text-gray-800 border-gray-300';
        }

        function getCategoryIcon(category) {
            const icons = {
                'Perizinan': 'üìã',
                'Lingkungan': 'üå±',
                'Keselamatan Kerja': '‚õëÔ∏è',
                'Teknis Pertambangan': '‚öíÔ∏è',
                'Reklamasi': 'üå≥',
                'Pajak & Royalti': 'üí∞',
                'Perda': 'üèõÔ∏è',
                'Lainnya': 'üìÑ'
            };
            return icons[category] || 'üìÑ';
        }

        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        function toggleAdmin() {
            state.isAdmin = !state.isAdmin;
            if (!state.isAdmin) state.activeTab = 'published';
            render();
        }

        function setActiveTab(tab) {
            state.activeTab = tab;
            state.currentPage = 1;
            render();
        }

        function toggleConfigPanel() {
            state.showConfigPanel = !state.showConfigPanel;
            render();
        }

        // Pagination
        function getPaginatedData() {
            const itemsPerPage = state.config.display.itemsPerPage;
            const start = (state.currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            return state.filteredRegs.slice(start, end);
        }

        function getTotalPages() {
            return Math.ceil(state.filteredRegs.length / state.config.display.itemsPerPage);
        }

        function changePage(page) {
            state.currentPage = page;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        // Render Functions
        function render() {
            log('Rendering, loading:', state.loading);
            const app = document.getElementById('app');
            
            if (state.loading) {
                app.innerHTML = renderLoading();
                return;
            }

            if (state.loadingError) {
                app.innerHTML = renderError();
                return;
            }

            app.innerHTML = `
                ${renderNotification()}
                ${renderHeader()}
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    ${state.isAdmin ? renderAdminTabs() : ''}
                    ${state.activeTab === 'published' || !state.isAdmin ? renderPublishedContent() : ''}
                    ${state.isAdmin && state.activeTab === 'pending' ? renderPendingContent() : ''}
                    ${state.isAdmin && state.activeTab === 'config' ? renderConfigContent() : ''}
                </div>
                ${state.showConfigPanel ? renderConfigPanel() : ''}
                ${state.processingAction ? renderProcessingOverlay() : ''}
            `;

            attachEventListeners();
        }

        function renderLoading() {
            return `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-600 text-lg mb-2">Memuat data dari GitHub...</p>
                        <p class="text-gray-500 text-sm">Repo: ${GITHUB_REPO}</p>
                        ${DEBUG ? `
                            <div class="mt-4 p-4 bg-gray-100 rounded-lg text-left text-xs max-w-md mx-auto">
                                <p class="font-bold mb-2">Debug Info:</p>
                                <p>API URL: ${GITHUB_API}</p>
                                <p>RAW URL: ${RAW_URL}</p>
                                <p class="mt-2 text-red-600">Check console (F12) untuk detail error</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderError() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="text-center max-w-2xl">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-4">Gagal Memuat Data</h1>
                        <p class="text-gray-600 mb-4">${state.loadingError}</p>
                        
                        <div class="bg-red-50 border-2 border-red-200 rounded-lg p-6 text-left mb-6">
                            <p class="font-bold text-red-800 mb-2">Kemungkinan Penyebab:</p>
                            <ul class="text-sm text-red-700 space-y-1">
                                <li>‚Ä¢ File regulations.json tidak ditemukan di repo</li>
                                <li>‚Ä¢ Format JSON tidak valid</li>
                                <li>‚Ä¢ Repository name salah: "${GITHUB_REPO}"</li>
                                <li>‚Ä¢ Repository bersifat private</li>
                                <li>‚Ä¢ Koneksi internet bermasalah</li>
                            </ul>
                        </div>

                        <div class="space-y-3">
                            <button onclick="location.reload()" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                                üîÑ Coba Lagi
                            </button>
                            <p class="text-sm text-gray-500">atau</p>
                            <a href="https://github.com/${GITHUB_REPO}/blob/main/regulations.json" target="_blank"
                                class="inline-block bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition">
                                üìÇ Cek File di GitHub
                            </a>
                        </div>

                        ${DEBUG ? `
                            <div class="mt-6 p-4 bg-gray-100 rounded-lg text-left text-xs">
                                <p class="font-bold mb-2">Debug Info:</p>
                                <p>Expected URL: ${RAW_URL}/regulations.json</p>
                                <p class="mt-2 text-red-600">Buka Console (F12) untuk detail lengkap</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderNotification() {
            if (!state.notification) return '';
            
            const colors = {
                success: 'bg-green-50 border-green-500 text-green-800',
                error: 'bg-red-50 border-red-500 text-red-800',
                info: 'bg-blue-50 border-blue-500 text-blue-800'
            };

            return `
                <div class="fixed top-4 right-4 z-50 fade-in">
                    <div class="border-l-4 p-4 rounded-lg shadow-xl max-w-md ${colors[state.notification.type]}">
                        <p class="font-medium">${state.notification.message}</p>
                    </div>
                </div>
            `;
        }

        function renderProcessingOverlay() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-8 text-center">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-700 font-medium">Memproses... Mohon tunggu</p>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header class="bg-gradient-to-r from-yellow-600 to-amber-600 text-white shadow-xl">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex items-center space-x-4">
                                <div class="bg-white p-3 rounded-lg shadow-lg">
                                    <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="text-3xl font-bold">Portal Peraturan ESDM, KLHK & Perda</h1>
                                    <p class="text-yellow-100 text-sm mt-1">Auto-Update ‚Ä¢ Config-Aware ‚Ä¢ GitHub Actions</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 flex-wrap gap-2">
                                ${state.isAdmin ? `
                                    <button onclick="toggleConfigPanel()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg font-semibold hover:bg-opacity-30 transition shadow-lg flex items-center gap-2">
                                        <span>‚öôÔ∏è</span>
                                        <span>Config</span>
                                    </button>
                                ` : ''}
                                <button onclick="toggleAdmin()" class="bg-white text-yellow-700 px-4 py-2 rounded-lg font-semibold hover:bg-yellow-50 transition shadow-lg">
                                    ${state.isAdmin ? 'üëÅÔ∏è Mode Publik' : 'üîê Mode Admin'}
                                </button>
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        function renderAdminTabs() {
            return `
                <div class="mb-6 bg-white rounded-xl shadow-lg p-2 flex space-x-2 overflow-x-auto">
                    <button onclick="setActiveTab('published')" class="flex-1 min-w-max px-6 py-3 rounded-lg font-semibold transition ${state.activeTab === 'published' ? 'bg-yellow-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                        ‚úì Published (${state.regulations.length})
                    </button>
                    <button onclick="setActiveTab('pending')" class="flex-1 min-w-max px-6 py-3 rounded-lg font-semibold transition ${state.activeTab === 'pending' ? 'bg-orange-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                        ‚è≥ Pending (${state.pendingRegs.length})
                    </button>
                    <button onclick="setActiveTab('config')" class="flex-1 min-w-max px-6 py-3 rounded-lg font-semibold transition ${state.activeTab === 'config' ? 'bg-yellow-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                        ‚öôÔ∏è Konfigurasi
                    </button>
                </div>
            `;
        }

        function renderPublishedContent() {
            return `
                ${state.config?.display?.showStats ? renderStats() : ''}
                ${renderFilters()}
                ${renderRegulationsList(getPaginatedData())}
                ${renderPagination()}
            `;
        }

        function renderPendingContent() {
            if (state.pendingRegs.length === 0) {
                return `
                    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                        <div class="text-6xl mb-4">üìã</div>
                        <p class="text-gray-500 text-lg">Tidak ada peraturan pending review</p>
                        <p class="text-gray-400 text-sm mt-2">Peraturan baru akan muncul di sini untuk direview</p>
                    </div>
                `;
            }

            return `
                <div class="space-y-6">
                    <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-6">
                        <h3 class="font-bold text-orange-800 mb-3">‚è≥ Pending Review</h3>
                        <p class="text-sm text-orange-700 mb-4">Peraturan berikut menunggu persetujuan untuk dipublikasikan.</p>
                        <div class="flex gap-3">
                            <button onclick="approveAllRegulations()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                                ‚úÖ Approve All
                            </button>
                            <button onclick="rejectAllRegulations()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                                ‚ùå Reject All
                            </button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${state.pendingRegs.map((reg, index) => `
                            <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all p-6 border-l-4 border-orange-500 fade-in">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center flex-wrap gap-2 mb-3">
                                            <span class="text-2xl">${getCategoryIcon(reg.category)}</span>
                                            <span class="px-3 py-1 rounded-full text-xs font-semibold border ${getMinistryColor(reg.ministry)}">${reg.ministry}</span>
                                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700 border border-gray-300">${reg.category}</span>
                                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-700 border border-orange-300">‚è≥ Pending</span>
                                        </div>
                                        <h3 class="text-xl font-bold text-gray-800 mb-2 hover:text-orange-700 transition">${reg.title}</h3>
                                        <p class="text-sm font-semibold text-orange-700 mb-3">${reg.number}</p>
                                        <p class="text-gray-600 mb-4 leading-relaxed">${reg.summary || ''}</p>
                                        <div class="flex items-center flex-wrap gap-4 text-sm text-gray-500">
                                            <span class="flex items-center gap-1">üìÖ ${formatDate(reg.date)}</span>
                                            ${reg.link ? `<a href="${reg.link}" target="_blank" class="text-orange-600 hover:text-orange-700 font-medium flex items-center gap-1 hover:underline">üì• Lihat Dokumen</a>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2 ml-4">
                                        <button onclick="approveRegulation(${index})" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition text-sm">
                                            ‚úÖ Approve
                                        </button>
                                        <button onclick="rejectRegulation(${index})" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition text-sm">
                                            ‚ùå Reject
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderStats() {
            const esdmCount = state.regulations.filter(r => r.ministry === 'ESDM').length;
            const klhkCount = state.regulations.filter(r => r.ministry === 'KLHK').length;
            const perdaCount = state.regulations.filter(r => r.ministry === 'Perda').length;

            return `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                        <p class="text-gray-500 text-sm font-medium">Total Peraturan</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">${state.regulations.length}</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-600">
                        <p class="text-gray-500 text-sm font-medium">ESDM</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">${esdmCount}</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-600">
                        <p class="text-gray-500 text-sm font-medium">KLHK</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">${klhkCount}</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-600">
                        <p class="text-gray-500 text-sm font-medium">Perda</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">${perdaCount}</p>
                    </div>
                </div>
            `;
        }

        function renderFilters() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2">
                            <input type="text" id="searchInput" placeholder="üîç Cari peraturan, nomor, atau kata kunci..." value="${state.searchTerm}" 
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition">
                        </div>
                        <div>
                            <select id="ministrySelect" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition">
                                ${ministries.map(m => `<option value="${m}" ${m === state.selectedMinistry ? 'selected' : ''}>${m}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <select id="categorySelect" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition">
                                ${categories.map(c => `<option value="${c}" ${c === state.selectedCategory ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPagination() {
            const totalPages = getTotalPages();
            if (totalPages <= 1) return '';

            const maxVisible = 5;
            let startPage = Math.max(1, state.currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            return `
                <div class="mt-8 flex justify-center items-center gap-2 flex-wrap">
                    <button onclick="changePage(${state.currentPage - 1})" ${state.currentPage === 1 ? 'disabled' : ''} 
                        class="px-4 py-2 rounded-lg bg-white border-2 border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        ‚Üê Prev
                    </button>
                    
                    ${startPage > 1 ? `
                        <button onclick="changePage(1)" class="px-4 py-2 rounded-lg bg-white border-2 border-gray-300 hover:bg-gray-50">1</button>
                        ${startPage > 2 ? '<span class="px-2">...</span>' : ''}
                    ` : ''}

                    ${Array.from({length: endPage - startPage + 1}, (_, i) => startPage + i).map(page => `
                        <button onclick="changePage(${page})" 
                            class="px-4 py-2 rounded-lg border-2 transition ${page === state.currentPage ? 'bg-yellow-600 text-white border-yellow-600' : 'bg-white border-gray-300 hover:bg-gray-50'}">
                            ${page}
                        </button>
                    `).join('')}

                    ${endPage < totalPages ? `
                        ${endPage < totalPages - 1 ? '<span class="px-2">...</span>' : ''}
                        <button onclick="changePage(${totalPages})" class="px-4 py-2 rounded-lg bg-white border-2 border-gray-300 hover:bg-gray-50">${totalPages}</button>
                    ` : ''}

                    <button onclick="changePage(${state.currentPage + 1})" ${state.currentPage === totalPages ? 'disabled' : ''} 
                        class="px-4 py-2 rounded-lg bg-white border-2 border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        Next ‚Üí
                    </button>
                </div>
                <div class="mt-4 text-center text-sm text-gray-600">
                    Menampilkan ${((state.currentPage - 1) * state.config.display.itemsPerPage) + 1} - ${Math.min(state.currentPage * state.config.display.itemsPerPage, state.filteredRegs.length)} dari ${state.filteredRegs.length} peraturan
                </div>
            `;
        }

        function renderRegulationsList(regulations) {
            if (regulations.length === 0) {
                return `
                    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                        <div class="text-6xl mb-4">üî≠</div>
                        <p class="text-gray-500 text-lg">Tidak ada peraturan yang ditemukan</p>
                    </div>
                `;
            }

            return `
                <div class="space-y-4">
                    ${regulations.map(reg => `
                        <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all p-6 border-l-4 border-yellow-500 fade-in">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center flex-wrap gap-2 mb-3">
                                        <span class="text-2xl">${getCategoryIcon(reg.category)}</span>
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold border ${getMinistryColor(reg.ministry)}">${reg.ministry}</span>
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700 border border-gray-300">${reg.category}</span>
                                        ${reg.verified ? '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 border border-green-300">‚úì Verified</span>' : ''}
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-2 hover:text-yellow-700 transition">${reg.title}</h3>
                                    <p class="text-sm font-semibold text-yellow-700 mb-3">${reg.number}</p>
                                    <p class="text-gray-600 mb-4 leading-relaxed">${reg.summary || ''}</p>
                                    <div class="flex items-center flex-wrap gap-4 text-sm text-gray-500">
                                        <span class="flex items-center gap-1">üìÖ ${formatDate(reg.date)}</span>
                                        ${reg.link ? `<a href="${reg.link}" target="_blank" class="text-yellow-600 hover:text-yellow-700 font-medium flex items-center gap-1 hover:underline">üì• Lihat Dokumen</a>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderConfigContent() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Konfigurasi Scraper</h2>
                    
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                        <h3 class="font-bold text-blue-800 mb-3">‚ÑπÔ∏è Informasi</h3>
                        <ul class="space-y-2 text-sm text-blue-700">
                            <li>‚Ä¢ Konfigurasi disimpan di GitHub (config.json)</li>
                            <li>‚Ä¢ Perubahan akan mempengaruhi scraping berikutnya</li>
                            <li>‚Ä¢ Scraper ESDM & KLHK: Setiap hari pukul 08:00 WIB</li>
                            <li>‚Ä¢ Scraper Perda: Setiap Minggu pukul 09:00 WIB</li>
                            <li>‚Ä¢ Refresh halaman dalam 1-2 menit setelah menyimpan</li>
                        </ul>
                    </div>

                    <div class="space-y-6">
                        <!-- ESDM/KLHK Settings -->
                        <div class="border-2 border-gray-200 rounded-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">JDIH ESDM & KLHK</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Limit per Run</label>
                                    <input type="number" value="${state.config.scraper.esdm_klhk.limit}" min="5" max="50"
                                        onchange="state.config.scraper.esdm_klhk.limit = parseInt(this.value)"
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Auto-publish (hari)</label>
                                    <input type="number" value="${state.config.scraper.esdm_klhk.auto_publish_days}" min="1" max="30"
                                        onchange="state.config.scraper.esdm_klhk.auto_publish_days = parseInt(this.value)"
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>

                        <!-- Perda Settings -->
                        <div class="border-2 border-purple-200 rounded-lg p-6">
                            <h3 class="text-lg font-bold text-purple-800 mb-4">Perda Scraper</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                        onchange="state.config.scraper.perda.enabled = this.value === 'true'">
                                        <option value="true" ${state.config.scraper.perda.enabled ? 'selected' : ''}>Aktif</option>
                                        <option value="false" ${!state.config.scraper.perda.enabled ? 'selected' : ''}>Nonaktif</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Limit per Provinsi</label>
                                    <input type="number" value="${state.config.scraper.perda.limit}" min="5" max="50"
                                        onchange="state.config.scraper.perda.limit = parseInt(this.value)"
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Keywords (pisahkan dengan koma)</label>
                                <input type="text" value="${state.config.scraper.perda.keywords.join(', ')}" 
                                    onchange="state.config.scraper.perda.keywords = this.value.split(',').map(s => s.trim())"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                    placeholder="pertambangan, tambang, mineral">
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="flex gap-3">
                            <button onclick="saveConfig()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                                üíæ Simpan ke GitHub
                            </button>
                            <button onclick="loadData()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                                üîÑ Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderConfigPanel() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-end" onclick="toggleConfigPanel()">
                    <div class="bg-white h-full w-full max-w-md overflow-y-auto slide-in" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-white border-b-2 border-gray-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-800">‚öôÔ∏è Quick Config</h2>
                            <button onclick="toggleConfigPanel()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="p-6 space-y-6">
                            <div>
                                <h3 class="font-bold text-gray-800 mb-3">Scraper Settings</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm text-gray-700 mb-2">ESDM/KLHK Limit</label>
                                        <input type="number" value="${state.config.scraper.esdm_klhk.limit}" min="5" max="50"
                                            onchange="state.config.scraper.esdm_klhk.limit = parseInt(this.value)"
                                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700 mb-2">Perda Limit</label>
                                        <input type="number" value="${state.config.scraper.perda.limit}" min="5" max="50"
                                            onchange="state.config.scraper.perda.limit = parseInt(this.value)"
                                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                                    </div>
                                </div>
                            </div>

                            <div class="pt-6 border-t">
                                <button onclick="saveConfig(); toggleConfigPanel()" 
                                    class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                                    üíæ Simpan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function attachEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const ministrySelect = document.getElementById('ministrySelect');
            const categorySelect = document.getElementById('categorySelect');

            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    state.searchTerm = e.target.value;
                    filterRegulations();
                    render();
                });
            }

            if (ministrySelect) {
                ministrySelect.addEventListener('change', (e) => {
                    state.selectedMinistry = e.target.value;
                    filterRegulations();
                    render();
                });
            }

            if (categorySelect) {
                categorySelect.addEventListener('change', (e) => {
                    state.selectedCategory = e.target.value;
                    filterRegulations();
                    render();
                });
            }
        }

        // Pending Review Functions
        async function approveRegulation(index) {
            if (!confirm('Apakah Anda yakin ingin menyetujui peraturan ini?')) return;

            state.processingAction = true;
            render();

            try {
                const reg = state.pendingRegs[index];
                if (!reg) return;

                // Move to published
                const publishedReg = {
                    ...reg,
                    publishedDate: new Date().toISOString(),
                    verified: true
                };

                state.regulations.unshift(publishedReg);
                state.pendingRegs.splice(index, 1);

                // Save to GitHub
                await saveRegulationsToRepo();

                showNotification(`‚úÖ "${reg.title}" telah disetujui dan dipublikasikan`, 'success');
                render();
            } catch (error) {
                console.error('Error approving regulation:', error);
                showNotification('‚ùå Gagal menyetujui peraturan', 'error');
            } finally {
                state.processingAction = false;
                render();
            }
        }

        async function rejectRegulation(index) {
            if (!confirm('Apakah Anda yakin ingin menolak peraturan ini?')) return;

            state.processingAction = true;
            render();

            try {
                const reg = state.pendingRegs[index];
                if (!reg) return;

                state.pendingRegs.splice(index, 1);

                // Save to GitHub
                await saveRegulationsToRepo();

                showNotification(`‚ùå "${reg.title}" telah ditolak`, 'info');
                render();
            } catch (error) {
                console.error('Error rejecting regulation:', error);
                showNotification('‚ùå Gagal menolak peraturan', 'error');
            } finally {
                state.processingAction = false;
                render();
            }
        }

        async function approveAllRegulations() {
            if (state.pendingRegs.length === 0) return;
            if (!confirm(`Apakah Anda yakin ingin menyetujui semua ${state.pendingRegs.length} peraturan pending?`)) return;

            state.processingAction = true;
            render();

            try {
                const approvedRegs = state.pendingRegs.map(reg => ({
                    ...reg,
                    publishedDate: new Date().toISOString(),
                    verified: true
                }));

                state.regulations.unshift(...approvedRegs);
                state.pendingRegs = [];

                // Save to GitHub
                await saveRegulationsToRepo();

                showNotification(`‚úÖ Semua ${approvedRegs.length} peraturan telah disetujui`, 'success');
                render();
            } catch (error) {
                console.error('Error approving all regulations:', error);
                showNotification('‚ùå Gagal menyetujui semua peraturan', 'error');
            } finally {
                state.processingAction = false;
                render();
            }
        }

        async function rejectAllRegulations() {
            if (state.pendingRegs.length === 0) return;
            if (!confirm(`Apakah Anda yakin ingin menolak semua ${state.pendingRegs.length} peraturan pending?`)) return;

            state.processingAction = true;
            render();

            try {
                const count = state.pendingRegs.length;
                state.pendingRegs = [];

                // Save to GitHub
                await saveRegulationsToRepo();

                showNotification(`‚ùå Semua ${count} peraturan telah ditolak`, 'info');
                render();
            } catch (error) {
                console.error('Error rejecting all regulations:', error);
                showNotification('‚ùå Gagal menolak semua peraturan', 'error');
            } finally {
                state.processingAction = false;
                render();
            }
        }

        async function saveRegulationsToRepo() {
            try {
                const payload = {
                    published: state.regulations,
                    pending: state.pendingRegs,
                    lastUpdated: new Date().toISOString()
                };

                const getResponse = await fetch(`${GITHUB_API}/contents/regulations.json`);
                const fileData = await getResponse.json();

                await fetch(`${GITHUB_API}/contents/regulations.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Update regulations from web interface',
                        content: btoa(JSON.stringify(payload, null, 2)),
                        sha: fileData.sha
                    })
                });

                log('Regulations saved to GitHub');
            } catch (error) {
                console.error('Error saving regulations:', error);
                throw error;
            }
        }

        // Initialize
        async function init() {
            log('=== INITIALIZATION START ===');
            log('Repository:', GITHUB_REPO);

            try {
                await loadConfig();
                await loadData();
                log('=== INITIALIZATION COMPLETE ===');
            } catch (error) {
                log('=== INITIALIZATION FAILED ===', error);
                console.error('Init error:', error);
                state.loading = false;
                state.loadingError = error.message;
                render();
            }
        }

        // Start app
        log('Starting app...');
        init();
    </script>
</body>
</html>
