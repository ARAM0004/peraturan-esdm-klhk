<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Peraturan ESDM, KLHK & Perda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #ca8a04;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 min-h-screen">
    <div id="app"></div>

    <script>
        const GITHUB_REPO = "ARAM0004/peraturan-esdm-klhk";
        const GITHUB_API = `https://api.github.com/repos/${GITHUB_REPO}`;
        const RAW_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main`;

        let state = {
            regulations: [],
            pendingRegs: [],
            filteredRegs: [],
            searchTerm: '',
            selectedCategory: 'Semua',
            selectedMinistry: 'Semua',
            isAdmin: false,
            activeTab: 'published',
            loading: true,
            lastScrapedDate: null,
            showConfigModal: false,
            showExportModal: false,
            processingAction: false,
            notification: null,
            config: null, // Will load from GitHub
            currentPage: 1,
            itemsPerPage: 20
        };

        const categories = ['Semua', 'Perizinan', 'Lingkungan', 'Keselamatan Kerja', 'Teknis Pertambangan', 'Reklamasi', 'Pajak & Royalti', 'Perda', 'Lainnya'];
        const ministries = ['Semua', 'ESDM', 'KLHK', 'Perda'];

        // Notification
        function showNotification(message, type = 'info') {
            state.notification = { message, type };
            render();
            setTimeout(() => {
                state.notification = null;
                render();
            }, 5000);
        }

        // Load config dari GitHub
        async function loadConfig() {
            try {
                const response = await fetch(`${RAW_URL}/config.json?t=${Date.now()}`);
                if (response.ok) {
                    state.config = await response.json();
                    console.log('‚úÖ Config loaded from GitHub');
                } else {
                    state.config = getDefaultConfig();
                    console.log('‚ö†Ô∏è Using default config');
                }
            } catch (error) {
                console.error('Error loading config:', error);
                state.config = getDefaultConfig();
            }
        }

        function getDefaultConfig() {
            return {
                scraper: {
                    esdm: {
                        enabled: true,
                        keywords: ["pertambangan", "mineral", "batubara"],
                        types: ["Peraturan Menteri", "Keputusan Menteri"],
                        limit: 10
                    },
                    klhk: {
                        enabled: true,
                        keywords: ["pertambangan", "lingkungan", "kehutanan"],
                        types: ["Peraturan Menteri", "Keputusan Menteri"],
                        limit: 10
                    },
                    perda: {
                        enabled: true,
                        keywords: ["pertambangan", "tambang", "mineral"],
                        limit: 20
                    }
                },
                general: {
                    auto_publish_days: 7
                }
            };
        }

        // Save config ke GitHub
        async function saveConfigToGitHub() {
            state.processingAction = true;
            render();

            try {
                const payload = {
                    action: 'update_config',
                    config: {
                        esdm: state.config.scraper.esdm,
                        klhk: state.config.scraper.klhk,
                        perda: state.config.scraper.perda,
                        general: state.config.general
                    },
                    updated_by: 'web_interface',
                    timestamp: new Date().toISOString()
                };

                // Get trigger file
                const getResponse = await fetch(`${GITHUB_API}/contents/trigger/config_update.json`);
                const fileData = await getResponse.json();

                // Update trigger
                const updateResponse = await fetch(`${GITHUB_API}/contents/trigger/config_update.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Update configuration from web',
                        content: btoa(JSON.stringify(payload, null, 2)),
                        sha: fileData.sha
                    })
                });

                if (updateResponse.ok) {
                    showNotification('‚úÖ Konfigurasi disimpan! Refresh dalam 2 menit.', 'success');
                    state.showConfigModal = false;
                } else {
                    throw new Error('Failed to update');
                }
            } catch (error) {
                console.error('Error saving config:', error);
                showNotification('‚ùå Gagal menyimpan konfigurasi', 'error');
            } finally {
                state.processingAction = false;
                render();
            }
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch(`${RAW_URL}/regulations.json?t=${Date.now()}`);
                if (!response.ok) throw new Error('Failed to fetch');
                
                const data = await response.json();
                state.regulations = data.published || [];
                state.pendingRegs = data.pending || [];
                state.lastScrapedDate = data.lastUpdated;
                
                showNotification('‚úÖ Data berhasil dimuat', 'success');
            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ö†Ô∏è Gagal memuat data', 'error');
            } finally {
                state.loading = false;
                filterRegulations();
                render();
            }
        }

        function filterRegulations() {
            let filtered = state.regulations;

            if (state.selectedMinistry !== 'Semua') {
                filtered = filtered.filter(reg => reg.ministry === state.selectedMinistry);
            }

            if (state.selectedCategory !== 'Semua') {
                filtered = filtered.filter(reg => reg.category === state.selectedCategory);
            }

            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                filtered = filtered.filter(reg =>
                    reg.title.toLowerCase().includes(term) ||
                    reg.number.toLowerCase().includes(term) ||
                    (reg.summary && reg.summary.toLowerCase().includes(term))
                );
            }

            state.filteredRegs = filtered;
        }

        // Helper functions
        function getMinistryColor(ministry) {
            const colors = {
                'ESDM': 'bg-blue-100 text-blue-800',
                'KLHK': 'bg-green-100 text-green-800',
                'Perda': 'bg-purple-100 text-purple-800'
            };
            return colors[ministry] || 'bg-gray-100 text-gray-800';
        }

        function getCategoryIcon(category) {
            const icons = {
                'Perizinan': 'üìã',
                'Lingkungan': 'üå±',
                'Keselamatan Kerja': '‚õëÔ∏è',
                'Teknis Pertambangan': '‚öíÔ∏è',
                'Reklamasi': 'üå≥',
                'Pajak & Royalti': 'üí∞',
                'Perda': 'üèõÔ∏è',
                'Lainnya': 'üìÑ'
            };
            return icons[category] || 'üìÑ';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function toggleAdmin() {
            state.isAdmin = !state.isAdmin;
            render();
        }

        function toggleConfigModal() {
            state.showConfigModal = !state.showConfigModal;
            render();
        }

        function setActiveTab(tab) {
            state.activeTab = tab;
            render();
        }

        // Render
        function render() {
            const app = document.getElementById('app');
            
            if (state.loading) {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="spinner mx-auto mb-4"></div>
                            <p class="text-gray-600">Memuat data...</p>
                        </div>
                    </div>
                `;
                return;
            }

            app.innerHTML = `
                ${state.notification ? `
                    <div class="fixed top-4 right-4 z-50 fade-in">
                        <div class="border-l-4 p-4 rounded-lg shadow-xl max-w-md ${
                            state.notification.type === 'success' ? 'bg-green-50 border-green-500 text-green-800' :
                            state.notification.type === 'error' ? 'bg-red-50 border-red-500 text-red-800' :
                            'bg-blue-50 border-blue-500 text-blue-800'
                        }">
                            <p class="font-medium">${state.notification.message}</p>
                        </div>
                    </div>
                ` : ''}
                
                <header class="bg-gradient-to-r from-yellow-600 to-amber-600 text-white shadow-xl">
                    <div class="max-w-7xl mx-auto px-4 py-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h1 class="text-3xl font-bold">Portal Peraturan ESDM, KLHK & Perda</h1>
                                <p class="text-yellow-100 text-sm mt-1">Config-Aware System ‚Ä¢ SULUT & KALTARA Fixed</p>
                            </div>
                            <div class="flex gap-3">
                                ${state.isAdmin ? `
                                    <button onclick="toggleConfigModal()" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30">
                                        ‚öôÔ∏è Config
                                    </button>
                                ` : ''}
                                <button onclick="toggleAdmin()" class="bg-white text-yellow-700 px-4 py-2 rounded-lg font-semibold hover:bg-yellow-50">
                                    ${state.isAdmin ? 'üëÅÔ∏è Publik' : 'üîê Admin'}
                                </button>
                            </div>
                        </div>
                    </div>
                </header>
                
                <div class="max-w-7xl mx-auto px-4 py-8">
                    ${state.isAdmin ? `
                        <div class="mb-6 bg-white rounded-xl shadow-lg p-2 flex gap-2">
                            <button onclick="setActiveTab('published')" class="flex-1 px-6 py-3 rounded-lg font-semibold ${state.activeTab === 'published' ? 'bg-yellow-600 text-white' : 'hover:bg-gray-100'}">
                                ‚úì Published (${state.regulations.length})
                            </button>
                            <button onclick="setActiveTab('pending')" class="flex-1 px-6 py-3 rounded-lg font-semibold ${state.activeTab === 'pending' ? 'bg-yellow-600 text-white' : 'hover:bg-gray-100'}">
                                ‚è∞ Pending (${state.pendingRegs.length})
                            </button>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-4 gap-6 mb-8">
                        ${['Total', 'ESDM', 'KLHK', 'Perda'].map((label, i) => {
                            const count = i === 0 ? state.regulations.length : state.regulations.filter(r => r.ministry === label).length;
                            return `<div class="bg-white rounded-xl shadow-lg p-6">
                                <p class="text-sm text-gray-500">${label}</p>
                                <p class="text-3xl font-bold">${count}</p>
                            </div>`;
                        }).join('')}
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <div class="grid grid-cols-4 gap-4">
                            <input type="text" id="searchInput" placeholder="üîç Cari..." value="${state.searchTerm}" 
                                class="col-span-2 px-4 py-3 border-2 rounded-lg">
                            <select id="ministrySelect" class="px-4 py-3 border-2 rounded-lg">
                                ${ministries.map(m => `<option ${m === state.selectedMinistry ? 'selected' : ''}>${m}</option>`).join('')}
                            </select>
                            <select id="categorySelect" class="px-4 py-3 border-2 rounded-lg">
                                ${categories.map(c => `<option ${c === state.selectedCategory ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${state.filteredRegs.length === 0 ? 
                            '<div class="bg-white p-12 rounded-xl text-center"><p class="text-gray-500">Tidak ada data</p></div>' :
                            state.filteredRegs.slice(0, state.itemsPerPage).map(reg => `
                                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                                    <div class="flex gap-2 mb-3">
                                        <span class="text-2xl">${getCategoryIcon(reg.category)}</span>
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${getMinistryColor(reg.ministry)}">${reg.ministry}</span>
                                        <span class="px-3 py-1 rounded-full text-xs bg-gray-100">${reg.category}</span>
                                    </div>
                                    <h3 class="text-xl font-bold mb-2">${reg.title}</h3>
                                    <p class="text-sm font-semibold text-yellow-700 mb-3">${reg.number}</p>
                                    <p class="text-gray-600 mb-3">${reg.summary || ''}</p>
                                    <div class="flex gap-4 text-sm text-gray-500">
                                        <span>üìÖ ${formatDate(reg.date)}</span>
                                        ${reg.link ? `<a href="${reg.link}" target="_blank" class="text-yellow-600 hover:underline">üì• Dokumen</a>` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
                
                ${state.showConfigModal ? renderConfigModal() : ''}
                ${state.processingAction ? '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-white p-8 rounded-xl"><div class="spinner mx-auto mb-4"></div><p>Memproses...</p></div></div>' : ''}
            `;

            attachEventListeners();
        }

        function renderConfigModal() {
            if (!state.config) return '';

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto" onclick="toggleConfigModal()">
                    <div class="bg-white rounded-xl p-8 max-w-4xl w-full my-8" onclick="event.stopPropagation()">
                        <h2 class="text-2xl font-bold mb-6">‚öôÔ∏è Konfigurasi Scraper</h2>
                        
                        <div class="space-y-6">
                            <!-- ESDM Config -->
                            <div class="border-2 border-blue-200 rounded-lg p-6">
                                <h3 class="font-bold text-blue-800 mb-4">JDIH ESDM</h3>
                                <div class="space-y-4">
                                    <label class="block">
                                        <span class="text-sm font-medium">Keywords (pisah dengan koma)</span>
                                        <input type="text" value="${state.config.scraper.esdm.keywords.join(', ')}" 
                                            onchange="state.config.scraper.esdm.keywords = this.value.split(',').map(s => s.trim())"
                                            class="w-full px-4 py-2 border-2 rounded-lg mt-2">
                                    </label>
                                    <label class="block">
                                        <span class="text-sm font-medium">Jenis Peraturan (pisah dengan koma)</span>
                                        <input type="text" value="${state.config.scraper.esdm.types.join(', ')}" 
                                            onchange="state.config.scraper.esdm.types = this.value.split(',').map(s => s.trim())"
                                            class="w-full px-4 py-2 border-2 rounded-lg mt-2">
                                        <p class="text-xs text-gray-500 mt-1">Contoh: Peraturan Menteri, Keputusan Menteri, Peraturan Pemerintah, Undang-Undang</p>
                                    </label>
                                    <label class="block">
                                        <span class="text-sm font-medium">Limit per Scraping</span>
                                        <input type="number" value="${state.config.scraper.esdm.limit}" min="5" max="50"
                                            onchange="state.config.scraper.esdm.limit = parseInt(this.value)"
                                            class="w-full px-4 py-2 border-2 rounded-lg mt-2">
                                    </label>
                                </div>
                            </div>

                            <!-- KLHK Config -->
                            <div class="border-2 border-green-200 rounded-lg p-6">
                                <h3 class="font-bold text-green-800 mb-4">JDIH KLHK</h3>
                                <div class="space-y-4">
                                    <label class="block">
                                        <span class="text-sm font-medium">Keywords (pisah dengan koma)</span>
                                        <input type="text" value="${state.config.scraper.klhk.keywords.join(', ')}" 
                                            onchange="state.config.scraper.klhk.keywords = this.value.split(',').map(s => s.trim())"
                                            class="w-full px-4 py-2 border-2 rounded-lg mt-2">
                                    </label>
                                    <label class="block">
                                        <span class="text-sm font-medium">Jenis Peraturan (pisah dengan koma)</span>
                                        <input type="text" value="${state.config.scraper.klhk.types.join(', ')}" 
                                            onchange="state.config.scraper.klhk.types = this.value.split(',').map(s => s.trim())"
                                            class="w-full px-4 py-2 border-2 rounded-lg mt-2">
                                    </label>
                                    <label class="block">
                                        <span class="text-sm font-medium">Limit per Scraping</span>
                                        <input type="number" value="${state.config.scraper.klhk.limit}" min="5" max="50"
                                            onchange="state.config.scraper.klhk.limit = parseInt(this.value)"
                                            class="w-full px-4 py-2 border-2 rounded-lg mt-2">
                                    </label>
                                </div>
                            </div>

                            <!-- Perda Config -->
                            <div class="border-2 border-purple-200 rounded-lg p-6">
                                <h3 class="font-bold text-purple-800 mb-4">Perda (SULUT & KALTARA - FIXED)</h3>
                                <div class="space-y-4">
                                    <label class="block">
                                        <span class="text-sm font-medium">Keywords (pisah dengan koma)</span>
                                        <input type="text" value="${state.config.scraper.perda.keywords.join(', ')}" 
                                            onchange="state.config.scraper.perda.keywords = this.value.split(',').map(s => s.trim())"
                                            class="w-full px-4 py-2 border-2 rounded-lg mt-2">
                                    </label>
                                    <label class="block">
                                        <span class="text-sm font-medium">Limit per Provinsi</span>
                                        <input type="number" value="${state.config.scraper.perda.limit}" min="5" max="50"
                                            onchange="state.config.scraper.perda.limit = parseInt(this.value)"
                                            class="w-full px-4 py-2 border-2 rounded-lg mt-2">
                                    </label>
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <p class="text-sm text-purple-800"><strong>Provinsi FIXED:</strong></p>
                                        <p class="text-sm text-purple-700 mt-1">‚úì Sulawesi Utara</p>
                                        <p class="text-sm text-purple-700">‚úì Kalimantan Utara</p>
                                    </div>
                                </div>
                            </div>

                            <!-- General Config -->
                            <div class="border-2 border-gray-200 rounded-lg p-6">
                                <h3 class="font-bold text-gray-800 mb-4">General Settings</h3>
                                <label class="block">
                                    <span class="text-sm font-medium">Auto-publish setelah (hari)</span>
                                    <input type="number" value="${state.config.general.auto_publish_days}" min="1" max="30"
                                        onchange="state.config.general.auto_publish_days = parseInt(this.value)"
                                        class="w-full px-4 py-2 border-2 rounded-lg mt-2">
                                </label>
                            </div>
                        </div>

                        <div class="mt-8 flex gap-4">
                            <button onclick="saveConfigToGitHub()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700">
                                üíæ Simpan ke GitHub
                            </button>
                            <button onclick="toggleConfigModal()" class="flex-1 bg-gray-200 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300">
                                Batal
                            </button>
                        </div>

                        <div class="mt-6 bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                            <p class="text-sm text-yellow-800"><strong>‚ö†Ô∏è Catatan:</strong></p>
                            <p class="text-sm text-yellow-700 mt-1">‚Ä¢ Config disimpan di GitHub (config.json)</p>
                            <p class="text-sm text-yellow-700">‚Ä¢ Perubahan akan affect scraper berikutnya</p>
                            <p class="text-sm text-yellow-700">‚Ä¢ Refresh halaman dalam 2 menit untuk melihat perubahan</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function attachEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const ministrySelect = document.getElementById('ministrySelect');
            const categorySelect = document.getElementById('categorySelect');

            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    state.searchTerm = e.target.value;
                    filterRegulations();
                    render();
                });
            }

            if (ministrySelect) {
                ministrySelect.addEventListener('change', (e) => {
                    state.selectedMinistry = e.target.value;
                    filterRegulations();
                    render();
                });
            }

            if (categorySelect) {
                categorySelect.addEventListener('change', (e) => {
                    state.selectedCategory = e.target.value;
                    filterRegulations();
                    render();
                });
            }
        }

        // Initialize
        loadConfig().then(() => loadData());
    </script>
</body>
</html>
