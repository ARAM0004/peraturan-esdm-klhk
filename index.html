<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peraturan ESDM & KLHK</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .tabs {
      display: flex;
      background: #f5f5f5;
      border-bottom: 2px solid #ddd;
    }

    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      background: #f5f5f5;
      border: none;
      font-size: 1em;
      transition: all 0.3s;
    }

    .tab:hover {
      background: #e0e0e0;
    }

    .tab.active {
      background: white;
      color: #667eea;
      font-weight: bold;
      border-bottom: 3px solid #667eea;
    }

    .content {
      padding: 30px;
      min-height: 500px;
    }

    .search-bar {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }

    .search-bar input {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
    }

    .search-bar select {
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
    }

    .regulation-card {
      background: #f9f9f9;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 10px;
      border-left: 5px solid #667eea;
      transition: all 0.3s;
    }

    .regulation-card:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .regulation-title {
      font-size: 1.3em;
      color: #333;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .regulation-meta {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #666;
      font-size: 0.9em;
    }

    .badge {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.85em;
      font-weight: bold;
    }

    .badge-ministry {
      background: #e3f2fd;
      color: #1976d2;
    }

    .badge-category {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .badge-pending {
      background: #fff3e0;
      color: #f57c00;
    }

    .regulation-summary {
      color: #555;
      margin: 10px 0;
      line-height: 1.6;
    }

    .regulation-link {
      display: inline-block;
      padding: 8px 15px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: all 0.3s;
    }

    .regulation-link:hover {
      background: #764ba2;
    }

    .config-section {
      background: #f9f9f9;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      border: 2px solid #ddd;
    }

    .config-section h3 {
      margin-bottom: 15px;
      color: #667eea;
    }

    .config-row {
      margin-bottom: 15px;
    }

    .config-row label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .config-row input, .config-row select, .config-row textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
    }

    .keyword-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .keyword-tag {
      background: #667eea;
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .keyword-tag button {
      background: rgba(255,255,255,0.3);
      border: none;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-weight: bold;
    }

    .keyword-tag button:hover {
      background: rgba(255,255,255,0.5);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #764ba2;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 1.2em;
    }

    .empty-state {
      text-align: center;
      padding: 60px;
      color: #999;
    }

    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #667eea;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 10px;
      width: 80%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close {
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #999;
    }

    .close:hover {
      color: #333;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .form-grid .full-width {
      grid-column: 1 / -1;
    }

    .admin-banner {
      background: #ffc107;
      color: #000;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
      border-radius: 5px;
    }

    .scraper-status {
      background: #e3f2fd;
      border: 2px solid #1976d2;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .scraper-status.running {
      background: #fff3e0;
      border-color: #f57c00;
    }

    .scraper-status.success {
      background: #e8f5e9;
      border-color: #4caf50;
    }

    .scraper-status.error {
      background: #ffebee;
      border-color: #f44336;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8em;
      font-weight: bold;
    }

    .log-console {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .log-console .log-line {
      margin: 2px 0;
    }

    .log-console .log-error {
      color: #ff5555;
    }

    .log-console .log-success {
      color: #50fa7b;
    }

    .log-console .log-info {
      color: #8be9fd;
    }

    .scraper-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #ddd;
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìú Peraturan ESDM & KLHK</h1>
      <p>Database Peraturan Kementerian ESDM dan KLHK</p>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('published')">üìã Published</button>
      <button class="tab" onclick="switchTab('pending')">‚è≥ Pending Review</button>
      <button class="tab" onclick="switchTab('scraper')">ü§ñ Scraper</button>
      <button class="tab" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
    </div>

    <div class="content" id="mainContent">
      <div class="loading">Loading data...</div>
    </div>
  </div>

  <!-- Modal for Add Regulation -->
  <div id="addRegulationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ûï Tambah Regulasi Baru</h2>
        <span class="close" onclick="closeAddModal()">&times;</span>
      </div>
      <div class="form-grid">
        <div class="full-width">
          <label>Judul</label>
          <input type="text" id="newTitle" placeholder="Contoh: Peraturan Menteri ESDM No. 1 Tahun 2025">
        </div>
        <div>
          <label>Nomor</label>
          <input type="text" id="newNumber" placeholder="Contoh: 1/2025">
        </div>
        <div>
          <label>Kementerian</label>
          <select id="newMinistry">
            <option value="ESDM">ESDM</option>
            <option value="KLHK">KLHK</option>
            <option value="Perda">Perda</option>
          </select>
        </div>
        <div>
          <label>Kategori</label>
          <input type="text" id="newCategory" placeholder="Contoh: Energi Terbarukan">
        </div>
        <div>
          <label>Tanggal</label>
          <input type="date" id="newDate">
        </div>
        <div class="full-width">
          <label>Link</label>
          <input type="url" id="newLink" placeholder="https://...">
        </div>
        <div class="full-width">
          <label>Ringkasan</label>
          <textarea id="newSummary" rows="4" placeholder="Deskripsi singkat peraturan..."></textarea>
        </div>
      </div>
      <div class="action-buttons">
        <button class="btn btn-success" onclick="saveNewRegulation()">Simpan</button>
        <button class="btn btn-secondary" onclick="closeAddModal()">Batal</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const GITHUB_REPO = 'ARAM0004/peraturan-esdm-klhk';
    const BRANCH = new URLSearchParams(window.location.search).get('branch') || 'scraper-dan-html';
    const RAW_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/${BRANCH}`;

   // GitHub API Configuration
    const GITHUB_API = {
      owner: 'ARAM0004',
      repo: 'peraturan-esdm-klhk',
      workflows: {
        v3: 'scraper_v3.yml',
        v4: 'scraper_perda_v4.yml'
      }
    };
    
    // Current selected workflow
    let selectedWorkflow = 'v4'; // default to v4

    // Scraper functions
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('id-ID');
      const log = `[${timestamp}] ${message}`;
      state.scraper.logs.push(log);
      
      // Keep only last 100 logs
      if (state.scraper.logs.length > 100) {
        state.scraper.logs.shift();
      }
      
      if (state.currentTab === 'scraper') {
        renderCurrentTab();
      }
    }

    // Check GitHub Actions workflow status
    async function checkWorkflowStatus() {
      try {
        const workflowFile = GITHUB_API.workflows[selectedWorkflow];
        const url = `https://api.github.com/repos/${GITHUB_API.owner}/${GITHUB_API.repo}/actions/workflows/${workflowFile}/runs?per_page=1`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`GitHub API error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.workflow_runs && data.workflow_runs.length > 0) {
          const latestRun = data.workflow_runs[0];
          return {
            status: latestRun.status,
            conclusion: latestRun.conclusion,
            createdAt: latestRun.created_at,
            updatedAt: latestRun.updated_at,
            runNumber: latestRun.run_number,
            htmlUrl: latestRun.html_url,
            event: latestRun.event
          };
        }
        
        return null;
      } catch (error) {
        console.error('Error checking workflow status:', error);
        return null;
      }
    }

    // Trigger GitHub Actions workflow (requires token)
    async function triggerWorkflow() {
      // Check if token is stored
      const token = localStorage.getItem('github_token');
      
      if (!token) {
        showTokenModal();
        return;
      }

      try {
        addLog('üîÑ Triggering GitHub Actions workflow...');
        addLog(`üìù Workflow: ${GITHUB_API.workflows[selectedWorkflow]}`);
        state.scraper.isRunning = true;
        renderCurrentTab();

        const workflowFile = GITHUB_API.workflows[selectedWorkflow];
        const url = `https://api.github.com/repos/${GITHUB_API.owner}/${GITHUB_API.repo}/actions/workflows/${workflowFile}/dispatches`;
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github+json',
            'Content-Type': 'application/json',
            'X-GitHub-Api-Version': '2022-11-28'
          },
          body: JSON.stringify({
            ref: BRANCH
          })
        });

        if (response.status === 204) {
          addLog('‚úÖ Workflow triggered successfully!');
          addLog('‚è≥ Waiting for workflow to start...');
          
          // Wait and check status
          await sleep(5000);
          await updateWorkflowStatus();
          
          // Start monitoring
          startWorkflowMonitoring();
        } else if (response.status === 401) {
          addLog('‚ùå Authentication failed. Token might be invalid.');
          localStorage.removeItem('github_token');
          showTokenModal();
        } else {
          const errorData = await response.json();
          addLog(`‚ùå Failed to trigger workflow: ${errorData.message || response.statusText}`);
        }
      } catch (error) {
        addLog(`‚ùå ERROR: ${error.message}`);
      } finally {
        state.scraper.isRunning = false;
        renderCurrentTab();
      }
    }

    // Update workflow status display
    async function updateWorkflowStatus() {
      const status = await checkWorkflowStatus();
      
      if (status) {
        state.scraper.lastRun = status.updatedAt;
        
        const statusEmoji = {
          'completed': '‚úÖ',
          'in_progress': 'üîÑ',
          'queued': '‚è≥',
          'waiting': '‚è∏Ô∏è'
        };
        
        const conclusionEmoji = {
          'success': '‚úÖ',
          'failure': '‚ùå',
          'cancelled': 'üö´',
          'skipped': '‚è≠Ô∏è'
        };
        
        const emoji = status.status === 'completed' 
          ? (conclusionEmoji[status.conclusion] || '‚ùì')
          : (statusEmoji[status.status] || '‚ùì');
        
        addLog(`${emoji} Workflow #${status.runNumber} - Status: ${status.status}${status.conclusion ? ` (${status.conclusion})` : ''}`);
        addLog(`üîó View details: ${status.htmlUrl}`);
        
        renderCurrentTab();
      }
    }

    // Monitor workflow progress
    let monitoringInterval = null;
    
    function startWorkflowMonitoring() {
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
      }
      
      addLog('üëÄ Monitoring workflow progress...');
      
      monitoringInterval = setInterval(async () => {
        const status = await checkWorkflowStatus();
        
        if (status) {
          if (status.status === 'completed') {
            clearInterval(monitoringInterval);
            monitoringInterval = null;
            
            if (status.conclusion === 'success') {
              addLog('üéâ Workflow completed successfully!');
              addLog('üîÑ Reloading data...');
              
              // Reload data after successful workflow
              setTimeout(async () => {
                await loadData();
                renderCurrentTab();
                addLog('‚úÖ Data reloaded!');
              }, 3000);
            } else {
              addLog(`‚ö†Ô∏è Workflow completed with status: ${status.conclusion}`);
            }
          } else if (status.status === 'in_progress') {
            addLog(`‚è≥ Workflow is running... (Check: ${new Date().toLocaleTimeString('id-ID')})`);
          }
        }
        
        renderCurrentTab();
      }, 15000); // Check every 15 seconds
    }

    function stopWorkflowMonitoring() {
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
        monitoringInterval = null;
        addLog('üõë Stopped monitoring workflow');
      }
    }

    // Token modal functions
    function showTokenModal() {
      const existingModal = document.getElementById('tokenModal');
      if (existingModal) {
        existingModal.style.display = 'block';
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'tokenModal';
      modal.className = 'modal';
      modal.style.display = 'block';
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2>üîë GitHub Personal Access Token</h2>
            <span class="close" onclick="closeTokenModal()">&times;</span>
          </div>
          <div style="margin: 20px 0;">
            <p style="color: #666; margin-bottom: 15px;">
              Untuk memicu workflow GitHub Actions, Anda memerlukan Personal Access Token dengan permission:
            </p>
            <ul style="margin-left: 20px; color: #666; line-height: 1.8;">
              <li><strong>repo</strong> scope (atau minimal <strong>actions:write</strong>)</li>
            </ul>
            <p style="color: #666; margin: 15px 0;">
              Token akan disimpan di browser (localStorage) dan tidak akan dikirim ke server lain.
            </p>
            <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin: 15px 0;">
              <strong>‚ö†Ô∏è Cara membuat token:</strong><br>
              1. Buka <a href="https://github.com/settings/tokens/new" target="_blank" style="color: #667eea;">GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)</a><br>
              2. Klik "Generate new token (classic)"<br>
              3. Beri nama token (contoh: "Peraturan ESDM Scraper")<br>
              4. Pilih scope: <strong>repo</strong> atau minimal <strong>public_repo</strong> + <strong>workflow</strong><br>
              5. Klik "Generate token" dan copy token yang muncul
            </div>
            <div class="config-row">
              <label>Paste your GitHub Token:</label>
              <input type="password" id="githubTokenInput" placeholder="ghp_xxxxxxxxxxxx" style="font-family: monospace;">
            </div>
            <p style="font-size: 0.85em; color: #999; margin-top: 10px;">
              Token akan tersimpan di browser Anda. Hapus token dengan tombol "Clear Token" di tab Scraper.
            </p>
          </div>
          <div class="action-buttons">
            <button class="btn btn-success" onclick="saveToken()">üíæ Save Token</button>
            <button class="btn btn-secondary" onclick="closeTokenModal()">Cancel</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function closeTokenModal() {
      const modal = document.getElementById('tokenModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    function saveToken() {
      const input = document.getElementById('githubTokenInput');
      const token = input.value.trim();
      
      if (!token) {
        alert('‚ö†Ô∏è Please enter a token!');
        return;
      }
      
      if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
        alert('‚ö†Ô∏è Token format tidak valid. GitHub token biasanya dimulai dengan "ghp_" atau "github_pat_"');
        return;
      }
      
      localStorage.setItem('github_token', token);
      closeTokenModal();
      alert('‚úÖ Token saved successfully!');
      
      // Try to trigger workflow now
      triggerWorkflow();
    }

    function clearToken() {
      if (confirm('Yakin ingin menghapus GitHub token yang tersimpan?')) {
        localStorage.removeItem('github_token');
        alert('‚úÖ Token cleared!');
        renderCurrentTab();
      }
    }

    function hasToken() {
      return !!localStorage.getItem('github_token');
    }
    
    // State
    const state = {
      currentTab: 'published',
      publishedRegs: [],
      pendingRegs: [],
      config: {
        keywords: {
          esdm: ['ESDM', 'energi', 'mineral', 'batubara'],
          klhk: ['KLHK', 'lingkungan', 'kehutanan'],
          perda: ['Perda', 'peraturan daerah']
        },
        limitPerRun: 50,
        autoPublish: false,
        autoPublishDate: null
      },
      searchTerm: '',
      filterMinistry: 'all',
      lastUpdated: null,
      scraper: {
        isRunning: false,
        progress: 0,
        logs: [],
        stats: {
          total: 0,
          success: 0,
          failed: 0,
          duplicate: 0
        },
        lastRun: null
      }
    };

// Initialize
    async function init() {
      await loadData();
      
      // Auto-check workflow status on load
      if (state.currentTab === 'scraper') {
        setTimeout(updateWorkflowStatus, 1000);
      }
      
      renderCurrentTab();
    }

    // Load data from GitHub
    async function loadData() {
      try {
        console.log(`Fetching from: ${RAW_URL}/regulations.json`);
        const response = await fetch(`${RAW_URL}/regulations.json`);
        
        if (!response.ok) {
          console.error("Gagal fetch regulations.json:", response.status, response.statusText);
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log("Data loaded:", data);
        
        state.publishedRegs = data.published || [];
        state.pendingRegs = data.pending || [];
        state.lastUpdated = data.lastUpdated;
        
        console.log("Published data:", state.publishedRegs.length, "items");
        console.log("Pending data:", state.pendingRegs.length, "items");
        
        // Load config if exists
        try {
          const configResponse = await fetch(`${RAW_URL}/config.json`);
          if (configResponse.ok) {
            const configData = await configResponse.json();
            state.config = { ...state.config, ...configData };
            console.log("Config loaded:", state.config);
          }
        } catch (e) {
          console.log("No config file found, using defaults");
        }
        
      } catch (error) {
        console.error("Error loading data:", error);
        showError("Gagal memuat data. Pastikan repository dan branch sudah benar.");
      }
    }

    // Switch tabs
    function switchTab(tabName) {
      state.currentTab = tabName;
      
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      renderCurrentTab();
    }

    // Render current tab
    function renderCurrentTab() {
      const content = document.getElementById('mainContent');
      
      switch(state.currentTab) {
        case 'published':
          renderPublishedContent(content);
          break;
        case 'pending':
          renderPendingContent(content);
          break;
        case 'scraper':
          renderScraperContent(content);
          break;
        case 'config':
          renderConfigContent(content);
          break;
      }
    }

    // Render published regulations
    function renderPublishedContent(container) {
      let html = `
        <div class="search-bar">
          <input type="text" placeholder="üîç Cari peraturan..." oninput="handleSearch(event)">
          <select onchange="handleFilter(event)">
            <option value="all">Semua Kementerian</option>
            <option value="ESDM">ESDM</option>
            <option value="KLHK">KLHK</option>
            <option value="Perda">Perda</option>
          </select>
        </div>
      `;

      const filtered = filterRegulations(state.publishedRegs);
      
      if (filtered.length === 0) {
        html += `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <h3>Tidak ada data</h3>
            <p>Belum ada peraturan yang dipublikasikan</p>
          </div>
        `;
      } else {
        filtered.forEach(reg => {
          html += createRegulationCard(reg);
        });
      }

      container.innerHTML = html;
    }

    // Render scraper content
    function renderScraperContent(container) {
      const scraper = state.scraper;
      const statusClass = scraper.isRunning ? 'running' : (scraper.logs.length > 0 && scraper.logs[scraper.logs.length - 1].includes('‚úÖ') ? 'success' : '');
      const tokenSaved = hasToken();
      
      let html = `
        <div class="admin-banner">
          ü§ñ Scraper Control Panel
        </div>
    
        <!-- Token Status -->
        <div class="scraper-status ${tokenSaved ? 'success' : ''}" style="margin-bottom: 15px;">
          <h3 style="margin-bottom: 10px;">
            ${tokenSaved ? 'üîë GitHub Token: Configured' : '‚ö†Ô∏è GitHub Token: Not Configured'}
          </h3>
          <p style="color: #666; font-size: 0.9em;">
            ${tokenSaved 
              ? 'Token tersimpan di browser. Anda dapat memicu workflow GitHub Actions.'
              : 'Anda perlu mengonfigurasi GitHub Personal Access Token untuk memicu workflow.'}
          </p>
          <div class="action-buttons" style="margin-top: 10px;">
            ${tokenSaved 
              ? '<button class="btn btn-danger" onclick="clearToken()">üóëÔ∏è Clear Token</button>'
              : '<button class="btn btn-primary" onclick="showTokenModal()">üîë Setup Token</button>'
            }
          </div>
        </div>
    
        <!-- Workflow Selection -->
        <div class="config-section" style="background: #f3e5f5; border-color: #7b1fa2; margin-bottom: 15px;">
          <h3 style="color: #7b1fa2; margin-bottom: 15px;">üéØ Select Workflow</h3>
          <div style="display: flex; gap: 10px; align-items: center;">
            <label style="font-weight: bold; color: #333;">Workflow:</label>
            <select id="workflowSelector" onchange="selectWorkflow(this.value)" 
                    style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em;"
                    ${scraper.isRunning ? 'disabled' : ''}>
              <option value="v4" ${selectedWorkflow === 'v4' ? 'selected' : ''}>
                üìú Scraper Perda V4 (scraper_perda_v4.yml)
              </option>
              <option value="v3" ${selectedWorkflow === 'v3' ? 'selected' : ''}>
                ‚ö° Scraper V3 (scraper_v3.yml)
              </option>
            </select>
          </div>
          <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
            <strong>V4:</strong> Fokus pada scraping Peraturan Daerah (Perda)<br>
            <strong>V3:</strong> Scraper umum untuk ESDM & KLHK
          </p>
        </div>
    
        <!-- Scraper Status -->
        <div class="scraper-status ${statusClass}">
          <h3 style="margin-bottom: 10px;">
            ${scraper.isRunning ? 'üîÑ Workflow Running...' : '‚ö° Ready to Trigger'}
          </h3>
          
          ${scraper.isRunning ? `
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${scraper.progress}%">
                ${scraper.progress}%
              </div>
            </div>
          ` : ''}
    
          <div class="scraper-controls">
            <button class="btn ${!tokenSaved || scraper.isRunning ? 'btn-secondary' : 'btn-success'}" 
                    onclick="triggerWorkflow()" 
                    ${!tokenSaved || scraper.isRunning ? 'disabled' : ''}>
              üöÄ Trigger Selected Workflow
            </button>
            <button class="btn btn-primary" 
                    onclick="updateWorkflowStatus()" 
                    ${scraper.isRunning ? 'disabled' : ''}>
              üîÑ Check Status
            </button>
            <button class="btn btn-secondary" 
                    onclick="startWorkflowMonitoring()" 
                    ${scraper.isRunning || monitoringInterval ? 'disabled' : ''}>
              üëÄ Start Monitoring
            </button>
            <button class="btn btn-danger" 
                    onclick="stopWorkflowMonitoring()" 
                    ${!monitoringInterval ? 'disabled' : ''}>
              üõë Stop Monitoring
            </button>
            <button class="btn btn-secondary" onclick="clearLogs()">
              üóëÔ∏è Clear Logs
            </button>
          </div>
    
          ${scraper.lastRun ? `
            <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
              Last workflow run: ${new Date(scraper.lastRun).toLocaleString('id-ID')}
            </p>
          ` : ''}
        </div>
    
        <!-- Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
          <div class="stat-card">
            <div class="stat-value">${scraper.stats.total}</div>
            <div class="stat-label">Total Scraped</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: #4caf50;">${scraper.stats.success}</div>
            <div class="stat-label">Success</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: #ff9800;">${scraper.stats.duplicate}</div>
            <div class="stat-label">Duplicate</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: #f44336;">${scraper.stats.failed}</div>
            <div class="stat-label">Failed</div>
          </div>
        </div>
    
        <!-- Console Log -->
        <div class="config-section">
          <h3>üìã Console Log</h3>
          <div class="log-console" id="scraperLogs">
            ${scraper.logs.length === 0 ? 
              '<div class="log-line log-info">Ready to trigger GitHub Actions workflow...</div>' :
              scraper.logs.map(log => `<div class="log-line ${getLogClass(log)}">${log}</div>`).join('')
            }
          </div>
        </div>
    
        <!-- Configuration Info -->
        <div class="config-section" style="background: #e3f2fd; border-color: #1976d2;">
          <h3 style="color: #1976d2;">‚ÑπÔ∏è Workflow Information</h3>
          <p><strong>Repository:</strong> ${GITHUB_API.owner}/${GITHUB_API.repo}</p>
          <p><strong>Selected Workflow:</strong> ${GITHUB_API.workflows[selectedWorkflow]}</p>
          <p><strong>Branch:</strong> ${BRANCH}</p>
          <p><strong>Trigger Type:</strong> workflow_dispatch (Manual)</p>
          <p style="margin-top: 10px;"><strong>Auto Schedule:</strong> ${selectedWorkflow === 'v4' ? 'Every Sunday at 2:00 AM UTC (09:00 WIB)' : 'Check workflow file for schedule'}</p>
        </div>
    
        <!-- Instructions -->
        <div class="config-section" style="background: #fff3e0; border-color: #f57c00;">
          <h3 style="color: #f57c00;">üìñ How to Use</h3>
          <ol style="margin-left: 20px; color: #666; line-height: 1.8;">
            <li><strong>First time:</strong> Click "Setup Token" to configure your GitHub Personal Access Token</li>
            <li><strong>Select Workflow:</strong> Choose between V3 (ESDM/KLHK) or V4 (Perda) using dropdown above</li>
            <li><strong>Trigger:</strong> Click "üöÄ Trigger Selected Workflow" to start the scraper</li>
            <li><strong>Monitor:</strong> Use "üëÄ Start Monitoring" to auto-check progress every 15 seconds</li>
            <li><strong>Wait:</strong> Workflow usually completes in 1-5 minutes</li>
            <li><strong>Auto-reload:</strong> Data refreshes automatically after successful completion</li>
          </ol>
          <p style="margin-top: 15px; color: #666;">
            <strong>Note:</strong> You can also view workflow progress directly on GitHub Actions page.
          </p>
        </div>
      `;
    
      container.innerHTML = html;
      
      // Auto scroll logs to bottom
      if (scraper.logs.length > 0) {
        setTimeout(() => {
          const logContainer = document.getElementById('scraperLogs');
          if (logContainer) {
            logContainer.scrollTop = logContainer.scrollHeight;
          }
        }, 100);
      }
    }
    
    // Select workflow
    function selectWorkflow(version) {
      selectedWorkflow = version;
      addLog(`üîÑ Switched to workflow: ${GITHUB_API.workflows[version]}`);
      renderCurrentTab();
    }

    // Get log class based on content
    function getLogClass(log) {
      if (log.includes('‚ùå') || log.includes('ERROR') || log.includes('Failed')) return 'log-error';
      if (log.includes('‚úÖ') || log.includes('SUCCESS') || log.includes('Complete')) return 'log-success';
      return 'log-info';
    }

    // Render pending regulations
    function renderPendingContent(container) {
      let html = `
        <div class="admin-banner">
          üîê Mode Admin - Pending Review
        </div>
      `;

      if (state.pendingRegs.length === 0) {
        html += `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M9 11l3 3L22 4"/>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
            </svg>
            <h3>Tidak ada pending</h3>
            <p>Semua peraturan sudah direview</p>
          </div>
        `;
      } else {
        state.pendingRegs.forEach((reg, index) => {
          html += createPendingCard(reg, index);
        });
      }

      container.innerHTML = html;
    }

    // Render configuration
    function renderConfigContent(container) {
      const config = state.config;
      
      let html = `
        <div class="admin-banner">
          ‚öôÔ∏è Configuration Panel
        </div>

        <!-- Keyword Editor -->
        <div class="config-section">
          <h3>üî§ Keyword Editor</h3>
          <p style="color: #666; margin-bottom: 15px;">Kelola keyword untuk scraping peraturan</p>
          
          <div class="config-row">
            <label>ESDM Keywords</label>
            <div class="keyword-list" id="esdmKeywords">
              ${config.keywords.esdm.map((kw, i) => `
                <div class="keyword-tag">
                  ${kw}
                  <button onclick="removeKeyword('esdm', ${i})">√ó</button>
                </div>
              `).join('')}
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <input type="text" id="newEsdmKeyword" placeholder="Tambah keyword baru...">
              <button class="btn btn-primary" onclick="addKeyword('esdm')">Tambah</button>
            </div>
          </div>

          <div class="config-row">
            <label>KLHK Keywords</label>
            <div class="keyword-list" id="klhkKeywords">
              ${config.keywords.klhk.map((kw, i) => `
                <div class="keyword-tag">
                  ${kw}
                  <button onclick="removeKeyword('klhk', ${i})">√ó</button>
                </div>
              `).join('')}
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <input type="text" id="newKlhkKeyword" placeholder="Tambah keyword baru...">
              <button class="btn btn-primary" onclick="addKeyword('klhk')">Tambah</button>
            </div>
          </div>

          <div class="config-row">
            <label>Perda Keywords</label>
            <div class="keyword-list" id="perdaKeywords">
              ${config.keywords.perda.map((kw, i) => `
                <div class="keyword-tag">
                  ${kw}
                  <button onclick="removeKeyword('perda', ${i})">√ó</button>
                </div>
              `).join('')}
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <input type="text" id="newPerdaKeyword" placeholder="Tambah keyword baru...">
              <button class="btn btn-primary" onclick="addKeyword('perda')">Tambah</button>
            </div>
          </div>
        </div>

        <!-- Scraping Limits -->
        <div class="config-section">
          <h3>‚ö° Limit Per Run</h3>
          <div class="config-row">
            <label>Jumlah maksimal regulasi per scraping run</label>
            <input type="number" value="${config.limitPerRun}" min="1" max="500" 
                   onchange="updateConfig('limitPerRun', parseInt(this.value))">
          </div>
        </div>

        <!-- Auto Publish -->
        <div class="config-section">
          <h3>ü§ñ Auto Publish</h3>
          <div class="config-row">
            <label style="display: flex; align-items: center; gap: 10px;">
              <span>Enable Auto Publish</span>
              <label class="toggle-switch">
                <input type="checkbox" ${config.autoPublish ? 'checked' : ''} 
                       onchange="updateConfig('autoPublish', this.checked)">
                <span class="slider"></span>
              </label>
            </label>
            <p style="color: #666; font-size: 0.9em; margin-top: 5px;">
              Otomatis memindahkan pending ke published pada tanggal yang ditentukan
            </p>
          </div>
          ${config.autoPublish ? `
            <div class="config-row">
              <label>Tanggal Auto Publish</label>
              <input type="date" value="${config.autoPublishDate || ''}" 
                     onchange="updateConfig('autoPublishDate', this.value)">
            </div>
          ` : ''}
        </div>

        <!-- Actions -->
        <div class="config-section">
          <h3>üéØ Actions</h3>
          <div class="action-buttons">
            <button class="btn btn-success" onclick="saveConfig()">üíæ Save Configuration</button>
            <button class="btn btn-primary" onclick="openAddModal()">‚ûï Tambah Regulasi Baru</button>
            <button class="btn btn-secondary" onclick="exportData()">üì• Export Data (Manual)</button>
          </div>
        </div>

        <!-- Info -->
        <div class="config-section" style="background: #e3f2fd; border-color: #1976d2;">
          <h3 style="color: #1976d2;">‚ÑπÔ∏è Information</h3>
          <p><strong>Branch:</strong> ${BRANCH}</p>
          <p><strong>Last Updated:</strong> ${state.lastUpdated ? new Date(state.lastUpdated).toLocaleString('id-ID') : 'N/A'}</p>
          <p><strong>Published:</strong> ${state.publishedRegs.length} items</p>
          <p><strong>Pending:</strong> ${state.pendingRegs.length} items</p>
        </div>
      `;

      container.innerHTML = html;
    }

    // Create regulation card
    function createRegulationCard(reg) {
      return `
        <div class="regulation-card">
          <div class="regulation-title">${reg.title}</div>
          <div class="regulation-meta">
            <span class="badge badge-ministry">${reg.ministry || 'N/A'}</span>
            <span class="badge badge-category">${reg.category || 'N/A'}</span>
            <div class="meta-item">üìÖ ${reg.date || 'N/A'}</div>
            <div class="meta-item">üìÑ ${reg.number || 'N/A'}</div>
          </div>
          <div class="regulation-summary">${reg.summary || 'Tidak ada ringkasan'}</div>
          ${reg.link ? `<a href="${reg.link}" target="_blank" class="regulation-link">Lihat Dokumen ‚Üí</a>` : ''}
        </div>
      `;
    }

    // Create pending card
    function createPendingCard(reg, index) {
      return `
        <div class="regulation-card">
          <div class="regulation-title">${reg.title}</div>
          <div class="regulation-meta">
            <span class="badge badge-ministry">${reg.ministry || 'N/A'}</span>
            <span class="badge badge-category">${reg.category || 'N/A'}</span>
            <span class="badge badge-pending">‚è≥ PENDING</span>
            <div class="meta-item">üìÖ ${reg.date || 'N/A'}</div>
          </div>
          <div class="regulation-summary">${reg.summary || 'Tidak ada ringkasan'}</div>
          <div class="action-buttons">
            <button class="btn btn-success" onclick="approveRegulation(${index})">‚úÖ Approve</button>
            <button class="btn btn-danger" onclick="rejectRegulation(${index})">‚ùå Reject</button>
            ${reg.link ? `<a href="${reg.link}" target="_blank" class="regulation-link">Lihat Dokumen</a>` : ''}
          </div>
        </div>
      `;
    }

    // Filter regulations
    function filterRegulations(regs) {
      return regs.filter(reg => {
        const matchesSearch = !state.searchTerm || 
          reg.title.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
          (reg.summary && reg.summary.toLowerCase().includes(state.searchTerm.toLowerCase()));
        
        const matchesFilter = state.filterMinistry === 'all' || 
          reg.ministry === state.filterMinistry;
        
        return matchesSearch && matchesFilter;
      });
    }

    // Event handlers
    function handleSearch(e) {
      state.searchTerm = e.target.value;
      renderCurrentTab();
    }

    function handleFilter(e) {
      state.filterMinistry = e.target.value;
      renderCurrentTab();
    }

    // Keyword management
    function addKeyword(type) {
      const input = document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Keyword`);
      const keyword = input.value.trim();
      
      if (keyword && !state.config.keywords[type].includes(keyword)) {
        state.config.keywords[type].push(keyword);
        input.value = '';
        renderCurrentTab();
      }
    }

    function removeKeyword(type, index) {
      state.config.keywords[type].splice(index, 1);
      renderCurrentTab();
    }

    // Config management
    function updateConfig(key, value) {
      if (key.includes('.')) {
        const keys = key.split('.');
        state.config[keys[0]][keys[1]] = value;
      } else {
        state.config[key] = value;
      }
      renderCurrentTab();
    }

    function saveConfig() {
      console.log("Saving config:", state.config);
      alert("‚ö†Ô∏è Fitur save ke GitHub memerlukan GitHub API token. Untuk saat ini, config tersimpan di memori browser.");
      // TODO: Implement GitHub API save
    }

    // Pending actions
    function approveRegulation(index) {
      const reg = state.pendingRegs[index];
      state.pendingRegs.splice(index, 1);
      state.publishedRegs.unshift(reg);
      renderCurrentTab();
      alert(`‚úÖ Regulasi "${reg.title}" berhasil di-approve!`);
      // TODO: Save to GitHub
    }

    function rejectRegulation(index) {
      const reg = state.pendingRegs[index];
      if (confirm(`Yakin ingin reject "${reg.title}"?`)) {
        state.pendingRegs.splice(index, 1);
        renderCurrentTab();
        alert(`‚ùå Regulasi berhasil di-reject`);
        // TODO: Save to GitHub
      }
    }

    // Add regulation modal
    function openAddModal() {
      document.getElementById('addRegulationModal').style.display = 'block';
      document.getElementById('newDate').valueAsDate = new Date();
    }

    function closeAddModal() {
      document.getElementById('addRegulationModal').style.display = 'none';
      // Clear form
      document.getElementById('newTitle').value = '';
      document.getElementById('newNumber').value = '';
      document.getElementById('newMinistry').value = 'ESDM';
      document.getElementById('newCategory').value = '';
      document.getElementById('newDate').valueAsDate = new Date();
      document.getElementById('newLink').value = '';
      document.getElementById('newSummary').value = '';
    }

    function saveNewRegulation() {
      const newReg = {
        title: document.getElementById('newTitle').value.trim(),
        number: document.getElementById('newNumber').value.trim(),
        ministry: document.getElementById('newMinistry').value,
        category: document.getElementById('newCategory').value.trim(),
        date: document.getElementById('newDate').value,
        link: document.getElementById('newLink').value.trim(),
        summary: document.getElementById('newSummary').value.trim(),
        status: 'Aktif',
        addedDate: new Date().toISOString()
      };

      // Validation
      if (!newReg.title) {
        alert('‚ö†Ô∏è Judul harus diisi!');
        return;
      }
      
      // Add to published
      state.publishedRegs.unshift(newReg);
      closeAddModal();
      switchTab('published');
      alert(`‚úÖ Regulasi "${newReg.title}" berhasil ditambahkan!`);
      
      console.log("New regulation added:", newReg);
      // TODO: Save to GitHub
    }

    // Export data
    function exportData() {
      const exportData = {
        published: state.publishedRegs,
        pending: state.pendingRegs,
        config: state.config,
        exportDate: new Date().toISOString(),
        branch: BRANCH
      };

      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `peraturan-esdm-klhk-export-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      alert('üì• Data berhasil diekspor!');
    }

    // Select workflow
    function selectWorkflow(version) {
      selectedWorkflow = version;
      addLog(`üîÑ Switched to workflow: ${GITHUB_API.workflows[version]}`);
      renderCurrentTab();
    }

    function clearLogs() {
      state.scraper.logs = [];
      state.scraper.stats = { total: 0, success: 0, failed: 0, duplicate: 0 };
      renderCurrentTab();
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Show error
    function showError(message) {
      const container = document.getElementById('mainContent');
      container.innerHTML = `
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color: #dc3545;">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          <h3>Error</h3>
          <p>${message}</p>
          <button class="btn btn-primary" onclick="init()">Coba Lagi</button>
        </div>
      `;
    }

// Close modal when clicking outside
    window.onclick = function(event) {
      const addModal = document.getElementById('addRegulationModal');
      const tokenModal = document.getElementById('tokenModal');
      
      if (event.target == addModal) {
        closeAddModal();
      }
      if (event.target == tokenModal) {
        closeTokenModal();
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopWorkflowMonitoring();
    });

    // Initialize app
    init();
  </script>
</body>
</html>
