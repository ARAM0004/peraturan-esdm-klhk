<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Peraturan ESDM & KLHK - Tambang Emas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #ca8a04;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        let state = {
            regulations: [],
            pendingRegs: [],
            filteredRegs: [],
            searchTerm: '',
            selectedCategory: 'Semua',
            selectedMinistry: 'Semua',
            isAdmin: false,
            activeTab: 'published',
            loading: true,
            lastScrapedDate: null,
            showAddOldForm: false,
            showDeleteConfirm: null
        };

        const categories = ['Semua', 'Perizinan', 'Lingkungan', 'Keselamatan Kerja', 'Teknis Pertambangan', 'Reklamasi', 'Pajak & Royalti', 'Perda', 'Lainnya'];
        const ministries = ['Semua', 'ESDM', 'KLHK', 'Perda', 'Gabungan'];

        const initialData = [
            {
                id: '1',
                title: 'Peraturan Menteri ESDM tentang Pertambangan Mineral dan Batubara',
                number: 'Permen ESDM No. 7 Tahun 2024',
                ministry: 'ESDM',
                category: 'Teknis Pertambangan',
                date: '2024-03-15',
                summary: 'Mengatur teknis pertambangan mineral dan batubara termasuk persyaratan eksplorasi dan eksploitasi untuk tambang emas',
                link: 'https://jdih.esdm.go.id',
                status: 'Aktif',
                verified: true
            },
            {
                id: '2',
                title: 'Peraturan Menteri KLHK tentang Izin Lingkungan',
                number: 'Permen LHK No. 4 Tahun 2024',
                ministry: 'KLHK',
                category: 'Lingkungan',
                date: '2024-02-20',
                summary: 'Persyaratan AMDAL dan izin lingkungan untuk kegiatan pertambangan termasuk pengelolaan limbah B3',
                link: 'https://jdih.menlhk.go.id',
                status: 'Aktif',
                verified: true
            }
        ];

        function getMinistryColor(ministry) {
            const colors = {
                'ESDM': 'bg-blue-100 text-blue-800',
                'KLHK': 'bg-green-100 text-green-800',
                'Perda': 'bg-purple-100 text-purple-800',
                'Gabungan': 'bg-orange-100 text-orange-800'
            };
            return colors[ministry] || 'bg-gray-100 text-gray-800';
        }

        function getCategoryIcon(category) {
            const icons = {
                'Perizinan': 'üìã',
                'Lingkungan': 'üå±',
                'Keselamatan Kerja': '‚õëÔ∏è',
                'Teknis Pertambangan': '‚öíÔ∏è',
                'Reklamasi': 'üå≥',
                'Pajak & Royalti': 'üí∞',
                'Perda': 'üèõÔ∏è',
                'Lainnya': 'üìÑ'
            };
            return icons[category] || 'üìÑ';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        async function loadData() {
            try {
                const githubUrl = 'https://raw.githubusercontent.com/ARAM0004/peraturan-esdm-klhk/main/regulations.json';
                const response = await fetch(githubUrl);
                
                if (!response.ok) throw new Error('Failed to fetch');
                
                const data = await response.json();
                state.regulations = data.published || initialData;
                state.pendingRegs = data.pending || [];
                state.lastScrapedDate = data.lastUpdated;
            } catch (error) {
                console.log('Using initial data', error);
                state.regulations = initialData;
                state.pendingRegs = [];
            } finally {
                state.loading = false;
                filterRegulations();
                render();
            }
        }

        function filterRegulations() {
            let filtered = state.regulations;

            if (state.selectedMinistry !== 'Semua') {
                filtered = filtered.filter(reg => reg.ministry === state.selectedMinistry);
            }

            if (state.selectedCategory !== 'Semua') {
                filtered = filtered.filter(reg => reg.category === state.selectedCategory);
            }

            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                filtered = filtered.filter(reg =>
                    reg.title.toLowerCase().includes(term) ||
                    reg.number.toLowerCase().includes(term) ||
                    reg.summary.toLowerCase().includes(term)
                );
            }

            state.filteredRegs = filtered;
        }

        function deleteRegulation(id) {
            state.showDeleteConfirm = id;
            render();
        }

        <script>
  // Fungsi hapus biasa yang kamu punya
  function confirmDelete() {
      const id = state.showDeleteConfirm;
      state.showDeleteConfirm = null;
      filterRegulations();
      render();

      // Panggil fungsi trigger API
      triggerDelete(id);
  }

  // Fungsi GitHub API
  async function triggerDelete(id) {
      const repo = "ARAM0004/peraturan-esdm-klhk";
      const path = "trigger/update.json";
      const apiUrl = `https://api.github.com/repos/${repo}/contents/${path}`;
      const token = "GANTI_DENGAN_TOKEN_REPO_YANG_AMAN";

      const triggerData = {
          delete_id: id,
          timestamp: new Date().toISOString()
      };

      const getRes = await fetch(apiUrl, {
          headers: { Authorization: `token ${token}` }
      });
      const fileData = await getRes.json();
      const sha = fileData.sha || null;

      await fetch(apiUrl, {
          method: "PUT",
          headers: {
              Authorization: `token ${token}`,
              "Content-Type": "application/json"
          },
          body: JSON.stringify({
              message: "Trigger regulation delete",
              content: btoa(JSON.stringify(triggerData, null, 2)),
              sha
          })
      });

      alert("‚úÖ Penghapusan sedang diproses! Tunggu ¬±1 menit agar data terupdate.");

            render();
        }

        function cancelDelete() {
            state.showDeleteConfirm = null;
            render();
        }

        function toggleAddOldForm() {
            state.showAddOldForm = !state.showAddOldForm;
            render();
        }

        function addOldRegulation() {
            const form = document.getElementById('addOldForm');
            const formData = new FormData(form);
            
            const newReg = {
                id: Date.now().toString(),
                title: formData.get('title'),
                number: formData.get('number'),
                ministry: formData.get('ministry'),
                category: formData.get('category'),
                date: formData.get('date'),
                summary: formData.get('summary'),
                link: formData.get('link'),
                status: formData.get('status'),
                verified: true,
                publishedDate: new Date().toISOString()
            };

            state.regulations = [newReg, ...state.regulations];
            state.showAddOldForm = false;
            filterRegulations();
            
            // Save to localStorage for demo
            localStorage.setItem('regulations-backup', JSON.stringify({
                published: state.regulations,
                pending: state.pendingRegs
            }));
            
            render();
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.loading) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 flex items-center justify-center">
                        <div class="text-center">
                            <div class="spinner mx-auto mb-4"></div>
                            <p class="text-gray-600 text-lg">Memuat data...</p>
                        </div>
                    </div>
                `;
                return;
            }

            app.innerHTML = `
                ${renderHeader()}
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    ${state.isAdmin ? renderAdminTabs() : ''}
                    ${state.activeTab === 'published' || !state.isAdmin ? renderPublishedContent() : ''}
                    ${state.isAdmin && state.activeTab === 'pending' ? renderPendingContent() : ''}
                    ${state.isAdmin && state.activeTab === 'scraper' ? renderScraperContent() : ''}
                </div>
                ${renderFooter()}
                ${state.showDeleteConfirm ? renderDeleteModal() : ''}
                ${state.showAddOldForm ? renderAddOldModal() : ''}
            `;

            attachEventListeners();
        }

        function renderHeader() {
            return `
                <header class="bg-gradient-to-r from-yellow-600 to-amber-600 text-white shadow-xl">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="bg-white p-3 rounded-lg shadow-lg">
                                    <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="text-3xl font-bold">Portal Peraturan ESDM, KLHK & Perda</h1>
                                    <p class="text-yellow-100 text-sm mt-1">Sistem Auto-Update dengan Approval Dashboard</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                ${state.isAdmin && state.pendingRegs.length > 0 ? `
                                    <button onclick="setActiveTab('pending')" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition shadow-lg">
                                        üîî ${state.pendingRegs.length} Perlu Review
                                    </button>
                                ` : ''}
                                <button onclick="toggleAdmin()" class="bg-white text-yellow-700 px-4 py-2 rounded-lg font-semibold hover:bg-yellow-50 transition shadow-lg">
                                    ${state.isAdmin ? 'üëÅÔ∏è Mode Publik' : 'üîê Mode Admin'}
                                </button>
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        function renderAdminTabs() {
            return `
                <div class="mb-6 bg-white rounded-xl shadow-lg p-2 flex space-x-2">
                    <button onclick="setActiveTab('published')" class="flex-1 px-6 py-3 rounded-lg font-semibold transition ${state.activeTab === 'published' ? 'bg-yellow-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                        ‚úì Published (${state.regulations.length})
                    </button>
                    <button onclick="setActiveTab('pending')" class="flex-1 px-6 py-3 rounded-lg font-semibold transition ${state.activeTab === 'pending' ? 'bg-yellow-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                        ‚è∞ Pending (${state.pendingRegs.length})
                    </button>
                    <button onclick="setActiveTab('scraper')" class="flex-1 px-6 py-3 rounded-lg font-semibold transition ${state.activeTab === 'scraper' ? 'bg-yellow-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                        üîÑ Auto-Scraper
                    </button>
                </div>
            `;
        }

        function renderPublishedContent() {
            return `
                ${renderStats()}
                ${renderFilters()}
                ${state.isAdmin ? renderAdminActions() : ''}
                ${renderRegulationsList()}
            `;
        }

        function renderAdminActions() {
            return `
                <div class="mb-6 flex space-x-3">
                    <button onclick="toggleAddOldForm()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-lg flex items-center space-x-2">
                        <span>üìù</span>
                        <span>Tambah Peraturan Lama</span>
                    </button>
                    <div class="flex-1"></div>
                    <span class="text-sm text-gray-500 self-center">Mode: Admin ‚óè ${state.regulations.length} peraturan</span>
                </div>
            `;
        }

        function renderStats() {
            const esdmCount = state.regulations.filter(r => r.ministry === 'ESDM').length;
            const klhkCount = state.regulations.filter(r => r.ministry === 'KLHK').length;
            const perdaCount = state.regulations.filter(r => r.ministry === 'Perda').length;
            const activeCount = state.regulations.filter(r => r.status === 'Aktif').length;

            return `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                        <p class="text-gray-500 text-sm font-medium">Total Peraturan</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">${state.regulations.length}</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-600">
                        <p class="text-gray-500 text-sm font-medium">ESDM</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">${esdmCount}</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-600">
                        <p class="text-gray-500 text-sm font-medium">KLHK</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">${klhkCount}</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-600">
                        <p class="text-gray-500 text-sm font-medium">Perda</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">${perdaCount}</p>
                    </div>
                </div>
            `;
        }

        function renderFilters() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2">
                            <input type="text" id="searchInput" placeholder="Cari peraturan..." value="${state.searchTerm}" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                        </div>
                        <div>
                            <select id="ministrySelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                ${ministries.map(m => `<option value="${m}" ${m === state.selectedMinistry ? 'selected' : ''}>${m}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <select id="categorySelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                ${categories.map(c => `<option value="${c}" ${c === state.selectedCategory ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRegulationsList() {
            if (state.filteredRegs.length === 0) {
                return `
                    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                        <p class="text-gray-500 text-lg">Tidak ada peraturan yang ditemukan</p>
                    </div>
                `;
            }

            return `
                <div class="space-y-4">
                    ${state.filteredRegs.map(reg => `
                        <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition p-6 border-l-4 border-yellow-500">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-3">
                                        <span class="text-2xl">${getCategoryIcon(reg.category)}</span>
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${getMinistryColor(reg.ministry)}">${reg.ministry}</span>
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700">${reg.category}</span>
                                        ${reg.verified ? '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">‚úì Verified</span>' : ''}
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">${reg.title}</h3>
                                    <p class="text-sm font-semibold text-yellow-700 mb-3">${reg.number}</p>
                                    <p class="text-gray-600 mb-3">${reg.summary}</p>
                                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                                        <span>üìÖ ${formatDate(reg.date)}</span>
                                        ${reg.link ? `<a href="${reg.link}" target="_blank" class="text-yellow-600 hover:text-yellow-700 font-medium">üì• Lihat Dokumen</a>` : ''}
                                    </div>
                                </div>
                                ${state.isAdmin ? `
                                    <button onclick="deleteRegulation('${reg.id}')" class="ml-4 p-2 text-red-600 hover:bg-red-50 rounded-lg transition">
                                        üóëÔ∏è
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderDeleteModal() {
            const reg = state.regulations.find(r => r.id === state.showDeleteConfirm);
            if (!reg) return '';

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="cancelDelete()">
                    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md mx-4" onclick="event.stopPropagation()">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">‚ö†Ô∏è Konfirmasi Hapus</h3>
                        <p class="text-gray-600 mb-2">Yakin ingin menghapus peraturan ini?</p>
                        <p class="text-sm font-semibold text-gray-800 mb-6">${reg.number}</p>
                        <div class="flex space-x-3">
                            <button onclick="confirmDelete()" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition">
                                Hapus
                            </button>
                            <button onclick="cancelDelete()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAddOldModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" onclick="toggleAddOldForm()">
                    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl mx-4 my-8" onclick="event.stopPropagation()">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">üìù Tambah Peraturan Lama</h3>
                        <div id="addOldForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Peraturan *</label>
                                    <input type="text" name="number" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal *</label>
                                    <input type="date" name="date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kementerian *</label>
                                    <select name="ministry" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="ESDM">ESDM</option>
                                        <option value="KLHK">KLHK</option>
                                        <option value="Perda">Perda</option>
                                        <option value="Gabungan">Gabungan</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori *</label>
                                    <select name="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        ${categories.filter(c => c !== 'Semua').map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Judul *</label>
                                <input type="text" name="title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ringkasan *</label>
                                <textarea name="summary" rows="3" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Link Dokumen</label>
                                <input type="url" name="link" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select name="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="Aktif">Aktif</option>
                                    <option value="Dicabut">Dicabut</option>
                                </select>
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button onclick="addOldRegulation()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                                    Simpan
                                </button>
                                <button onclick="toggleAddOldForm()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                                    Batal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPendingContent() {
            return `<div class="bg-white rounded-xl shadow-lg p-12 text-center"><p class="text-gray-500">Pending regulations</p></div>`;
        }

        function renderScraperContent() {
            return `<div class="bg-white rounded-xl shadow-lg p-12 text-center"><p class="text-gray-500">Scraper status</p></div>`;
        }

        function renderFooter() {
            return `
                <footer class="bg-gray-800 text-gray-300 mt-16">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
                        <p class="text-sm">Portal Peraturan ESDM, KLHK & Perda - Sistem Auto-Update</p>
                        <p class="text-xs text-gray-400 mt-2">¬© 2024</p>
                    </div>
                </footer>
            `;
        }

        function attachEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const ministrySelect = document.getElementById('ministrySelect');
            const categorySelect = document.getElementById('categorySelect');

            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    state.searchTerm = e.target.value;
                    filterRegulations();
                    render();
                });
            }

            if (ministrySelect) {
                ministrySelect.addEventListener('change', (e) => {
                    state.selectedMinistry = e.target.value;
                    filterRegulations();
                    render();
                });
            }

            if (categorySelect) {
                categorySelect.addEventListener('change', (e) => {
                    state.selectedCategory = e.target.value;
                    filterRegulations();
                    render();
                });
            }
        }

        function toggleAdmin() {
            state.isAdmin = !state.isAdmin;
            if (!state.isAdmin) state.activeTab = 'published';
            render();
        }

        function setActiveTab(tab) {
            state.activeTab = tab;
            render();
        }

        loadData();
    </script>
</body>
</html>
